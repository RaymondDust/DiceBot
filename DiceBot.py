import os
import logging
import random
import json                     # <-- 1. Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ JSON
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð· .env (Ñ‚Ð¾ÐºÐµÐ½)
load_dotenv()

# ========== 2. ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯ (Ð¿ÐµÑ€ÐµÐ½ÐµÑÐµÐ½Ð¾ Ð²Ð²ÐµÑ€Ñ…) ==========
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)   # Ñ‚ÐµÐ¿ÐµÑ€ÑŒ logger Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð´Ð»Ñ Ð²ÑÐµÐ³Ð¾ ÐºÐ¾Ð´Ð° Ð½Ð¸Ð¶Ðµ

# ========== 3. ÐÐžÐ’Ð«Ð™ Ð‘Ð›ÐžÐš: Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ñ€Ð°Ð· Ð¸Ð· JSON ==========
def load_phrases():
    """Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ Ñ„Ñ€Ð°Ð·Ñ‹ Ð¸Ð· JSON-Ñ„Ð°Ð¹Ð»Ð° Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ {Ñ‡Ð¸ÑÐ»Ð¾: Ñ„Ñ€Ð°Ð·Ð°}"""
    try:
        with open('phrases.json', 'r', encoding='utf-8') as f:
            phrases = json.load(f)
        # ÐŸÑ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÐºÐ»ÑŽÑ‡Ð¸ Ð¸Ð· ÑÑ‚Ñ€Ð¾Ðº Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² Ñ‡Ð¸ÑÐ»Ð°
        return {int(key): value for key, value in phrases.items()}
    except FileNotFoundError:
        logger.error("Ð¤Ð°Ð¹Ð» phrases.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ñ„Ñ€Ð°Ð·Ñ‹.")
        return {}
    except json.JSONDecodeError:
        logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ phrases.json! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ñ„Ñ€Ð°Ð·Ñ‹.")
        return {}

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ„Ñ€Ð°Ð·Ñ‹ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ
PHRASES = load_phrases()
# ========== ÐšÐžÐÐ•Ð¦ ÐÐžÐ’ÐžÐ“Ðž Ð‘Ð›ÐžÐšÐ ==========

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ‚Ð¾ÐºÐµÐ½ ÐµÑÑ‚ÑŒ
TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    raise ValueError("Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ñ„Ð°Ð¹Ð» .env Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ BOT_TOKEN.")

# ---- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸-Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´ ----
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ ÐºÑƒÐ±Ð¸Ðº d20. ÐÐ°Ð¿Ð¸ÑˆÐ¸ /roll, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ."
    )

# ========== 4. Ð˜Ð—ÐœÐ•ÐÐÐÐÐÐ¯ Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯ roll (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ PHRASES) ==========
async def roll(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_name = update.effective_user.first_name
    result = random.randint(1, 20)

    # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ„Ñ€Ð°Ð·Ñƒ Ð¸Ð· ÑÐ»Ð¾Ð²Ð°Ñ€Ñ PHRASES
    phrase = PHRASES.get(result)

    # Ð•ÑÐ»Ð¸ Ñ„Ñ€Ð°Ð·Ñ‹ Ð½ÐµÑ‚ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ñ„Ð°Ð¹Ð» Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸Ð»Ð¸ Ð² Ð½Ñ‘Ð¼ Ð½ÐµÑ‚ Ñ‚Ð°ÐºÐ¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°) â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð·Ð°Ð¿Ð°ÑÐ½Ð¾Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚
    if not phrase:
        if result == 1:
            phrase = "ðŸ’¥ðŸ’¥ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð°! Ð’ÑÑ‘ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ð¿Ð¾ Ð¿Ð»Ð°Ð½Ñƒ./nÐÑ‚Ð°ÐºÐ°: ÐÑ‚Ð°ÐºÐ° Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð½ÑƒÐ»Ð°ÑÑŒ! Ð’Ð¼ÐµÑÑ‚Ð¾ Ð°Ñ‚Ð°ÐºÐ¸ Ð¿Ð¾ Ð²Ñ€Ð°Ð³Ñƒ, Ñ‚Ñ‹ Ð½Ð°ÑÑ‘Ñ ÑÐµÐ±Ðµ Ð¼Ð°Ð»ÐµÐ¹ÑˆÐ¸Ð¹ ÑƒÑ€Ð¾Ð½./nÐ”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÑÑ‚Ð¸ Ð»Ð¸Ð±Ð¾ Ñ‚Ñ‹ ÑÐ´ÐµÐ»Ð°Ð» ÐµÐ³Ð¾ ÑƒÐ¶Ð°ÑÐ½Ð¾!"
        elif result == 20:
            phrase = "ðŸŽ‰ðŸŽ‰ ÐšÑ€Ð¸Ñ‚! Ð¢Ñ‹ Ð¿Ñ€ÐµÐ²Ð·Ð¾ÑˆÑ‘Ð» Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ! /nÐÑ‚Ð°ÐºÐ°: Ð¢Ñ‹ Ð¿Ð¾Ñ€Ð°Ð¶Ð°ÐµÑˆÑŒ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð½Ð¸ÐºÐ°, Ð½Ð°Ð½Ð¾ÑÑ ÐµÐ¼Ñƒ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑƒÑ€Ð¾Ð½! /nÐ”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾Ð´ÐµÐ»Ð°Ð½Ð½Ð¾ Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð° Ð¸ Ð´Ð°Ð¶Ðµ Ð»ÑƒÑ‡ÑˆÐµ, Ñ‡ÐµÐ¼ Ð·Ð°Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð»Ð¾ÑÑŒ!"
        elif 2 <= result <= 5:
            phrase = "ðŸ˜• ÐžÑ‡ÐµÐ½ÑŒ Ð¿Ð»Ð¾Ñ…Ð¾. /nÐÑ‚Ð°ÐºÐ°: ÐÑ‚Ð°ÐºÐ° Ð»Ð¸ÑˆÑŒ Ñ‡ÑƒÑ‚ÑŒ Ð·Ð°Ð´ÐµÐ»Ð° Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð½Ð¸ÐºÐ°, Ð½Ð°Ð½ÐµÑÑ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ ÑƒÑ€Ð¾Ð½ Ð¸Ð»Ð¸ Ð²Ð¾Ð²ÑÐµ Ð½Ðµ Ð½Ð°ÑÐµÑÑ ÐµÐ³Ð¾. /nÐ”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð¾ Ð³Ð°Ñ€Ð°Ð·Ð´Ð¾ Ñ…ÑƒÐ¶Ðµ, Ñ‡ÐµÐ¼ Ñ‚Ñ‹ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ð»Ð°Ð³Ð°Ð»."
        elif 6 <= result <= 10:
            phrase = "ðŸ¤” Ð¢Ð°Ðº ÑÐµÐ±Ðµ. /nÐÑ‚Ð°ÐºÐ°: ÐÑ‚Ð°ÐºÐ° Ð¿Ñ€Ð¾ÑˆÐ»Ð° Ð»Ð¸ÑˆÑŒ Ð²ÑÐºÐ¾Ð»ÑŒÐ·ÑŒ, Ð½Ð¾ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ Ð½Ð°Ð½ÐµÑÐ»Ð° ÑƒÑ€Ð¾Ð½, Ñ…Ð¾Ñ‚ÑŒ Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ. /nÐ”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: Ð¢Ð²Ð¾Ñ‘ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ Ñ…ÑƒÐ¶Ðµ, Ñ‡ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ð»Ð¾Ð³Ð°Ð»Ð¾ÑÑŒ, Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð½ÐµÑƒÐ´Ð°Ñ‡Ð°."
        elif 11 <= result <= 15:
            phrase = "ðŸ‘ðŸ‘ ÐÐµÐ¿Ð»Ð¾Ñ…Ð¾. /nÐÑ‚Ð°ÐºÐ°: ÐÑ‚Ð°ÐºÐ° Ð¿Ñ€Ð¾ÑˆÐ»Ð° Ñ‡ÑƒÑ‚ÑŒ ÑÐ»Ð°Ð±ÐµÐµ Ñ‡ÐµÐ¼ Ð·Ð°Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ð»Ð¾ÑÑŒ. /nÐ”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ, Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¸Ð»Ð¸ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾."
        elif 16 <= result <= 19:
            phrase = "ðŸŒŸðŸŒŸ ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! Ð­Ñ‚Ð¾ ÐµÑ‰Ñ‘ Ð½Ðµ ÐºÑ€Ð¸Ñ‚, Ð½Ð¾ Ð¸ Ð½Ðµ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð°. /nÐÑ‚Ð°ÐºÐ°: Ð¢Ñ‹ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ñ€Ð°Ð¶Ð°ÐµÑˆÑŒ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð½Ð¸ÐºÐ°, Ð½Ð¸ÐºÐ°ÐºÐ¾Ð³Ð¾ Ð´Ð¾Ð¿. ÑƒÑ€Ð¾Ð½Ð°. /nÐ”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ: Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾Ð´ÐµÐ»Ð°Ð½Ð½Ð¾ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾, Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº, Ð½Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð±Ñ‹Ð»Ð¾ Ð¸ Ð»ÑƒÑ‡ÑˆÐµ."
        else:
            phrase = f"Ð’Ñ‹Ð¿Ð°Ð»Ð¾ {result}. Ð¡ÑƒÐ´Ð¸Ñ‚Ðµ ÑÐ°Ð¼Ð¸."

    await update.message.reply_text(
        f"{user_name}, Ñ‚Ñ‹ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ¸Ð»(Ð°): **{result}**\n{phrase}",
        parse_mode='Markdown'
    )
# ========== ÐšÐžÐÐ•Ð¦ Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð™ ==========

# ---- Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ----
def main():
    # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (Ð±Ð¾Ñ‚Ð°)
    application = Application.builder().token(TOKEN).build()

    # Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("roll", roll))

    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
    logger.info("ðŸš€ Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!")
    application.run_polling()

if __name__ == "__main__":
    main()